{# templates/transaction/index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Transaction Ledger{% endblock %}

{% block body %}
    <div class="max-w-[1400px] mx-auto px-6 py-10 antialiased">

        {# --- SAPPHIRE FILTER HEADER --- #}
        <div class="relative overflow-hidden bg-slate-900 rounded-[2.5rem] p-8 mb-8 shadow-2xl shadow-slate-900/30 border border-slate-800">
            <div class="absolute top-0 right-0 -mr-20 -mt-20 w-80 h-80 bg-blue-500/10 rounded-full blur-3xl"></div>

            <div class="relative flex flex-col lg:flex-row justify-between items-center gap-8">
                <div class="flex-shrink-0">
                    <h1 class="text-3xl font-black text-white tracking-tight mb-1">Stock Ledger</h1>
                    <p class="text-slate-400 font-bold uppercase text-[9px] tracking-[0.3em]">Chronological Movement Log</p>
                </div>

                {# Filter Form #}
                <form id="filterForm" method="GET" action="{{ path('app_transaction_index') }}" class="flex flex-col md:flex-row items-end gap-4 w-full">

                    {# NEW: Search Bar #}
                    <div class="w-full md:flex-grow">
                        <label class="block text-[8px] font-black text-slate-500 uppercase tracking-widest mb-2 ml-1">Search Product</label>
                        <div class="relative">
                            <input type="text" name="search" value="{{ app.request.query.get('search') }}"
                                   placeholder="Type name..."
                                   id="searchInput"
                                   class="w-full bg-slate-800 border-2 border-slate-700 focus:border-blue-500 rounded-xl px-10 py-2.5 text-white font-bold text-[11px] outline-none transition-all">
                            <svg class="w-4 h-4 text-slate-500 absolute left-4 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="3" stroke-linecap="round"/></svg>
                        </div>
                    </div>

                    {# Category Filter #}
                    <div class="w-full md:w-48">
                        <label class="block text-[8px] font-black text-slate-500 uppercase tracking-widest mb-2 ml-1">Category</label>
                        <select name="category" onchange="this.form.submit()" class="w-full bg-slate-800 border-2 border-slate-700 focus:border-blue-500 rounded-xl px-4 py-2.5 text-white font-bold text-[11px] outline-none transition-all cursor-pointer">
                            <option value="all">All</option>
                            {% for cat in categories %}
                                <option value="{{ cat.id }}" {{ currentCat == cat.id ? 'selected' : '' }}>{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    {# Date Filters #}
                    <div class="flex gap-2 w-full md:w-auto">
                        <div>
                            <label class="block text-[8px] font-black text-slate-500 uppercase tracking-widest mb-2 ml-1">Start</label>
                            <input type="date" name="start_date" value="{{ startDate }}" onchange="this.form.submit()" class="bg-slate-800 border-2 border-slate-700 focus:border-blue-500 rounded-xl px-4 py-2 text-white font-bold text-[11px] outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-[8px] font-black text-slate-500 uppercase tracking-widest mb-2 ml-1">End</label>
                            <input type="date" name="end_date" value="{{ endDate }}" onchange="this.form.submit()" class="bg-slate-800 border-2 border-slate-700 focus:border-blue-500 rounded-xl px-4 py-2 text-white font-bold text-[11px] outline-none transition-all">
                        </div>
                    </div>

                    {# Actualise/Reset #}
                    <a href="{{ path('app_transaction_index') }}" class="w-full md:w-auto px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-black rounded-xl shadow-lg transition-all active:scale-95 uppercase tracking-widest text-center">
                        Actualise
                    </a>
                </form>
            </div>
        </div>

        {# --- LIST OF TRANSACTIONS --- #}
        <div class="space-y-4">
            {% for trx in transactions %}
                <div class="group relative flex flex-col md:flex-row items-center bg-white rounded-[2.5rem] p-5 border border-slate-100 shadow-sm hover:shadow-xl hover:border-blue-100 transition-all duration-500">

                    <div class="w-20 h-20 rounded-[1.5rem] overflow-hidden flex-shrink-0 border-4 border-slate-50 shadow-inner bg-slate-100">
                        {% if trx.product and trx.product.imageUrl %}
                            <img src="{{ asset('uploads/products/' ~ trx.product.imageUrl) }}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                        {% else %}
                            <div class="w-full h-full flex items-center justify-center text-xl bg-slate-200 text-slate-400">ðŸ“¦</div>
                        {% endif %}
                    </div>

                    <div class="mt-4 md:mt-0 md:ml-6 flex-grow">
                        <div class="flex items-center gap-3 mb-1">
                        <span class="px-2 py-0.5 bg-slate-100 text-slate-500 rounded text-[8px] font-black uppercase tracking-widest">
                            {{ trx.product ? trx.product.category.name : 'System' }}
                        </span>
                        </div>
                        <h2 class="text-lg font-black text-slate-800 uppercase tracking-tight group-hover:text-blue-600 transition-colors">
                            {{ trx.product ? trx.product.name : 'Deleted Product' }}
                        </h2>
                    </div>

                    <div class="mt-4 md:mt-0 md:px-8 text-center md:text-right border-t md:border-t-0 md:border-l border-slate-50 pt-4 md:pt-0">
                        {% set isRestock = trx.type|upper == 'RESTOCK' %}
                        <div class="text-2xl font-black tracking-tighter {{ isRestock ? 'text-emerald-500' : 'text-rose-500' }}">
                            {{ isRestock ? '+' : '-' }}{{ trx.quantity|number_format(0) }}
                            <span class="text-[9px] uppercase ml-1 opacity-60">{{ trx.product ? trx.product.unit : '' }}</span>
                        </div>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">
                            {{ trx.createdAt|date('d M Y â€¢ H:i') }}
                        </p>
                    </div>

                    <div class="hidden lg:flex items-center justify-center w-28 px-4 py-2 rounded-xl {{ isRestock ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600' }} ml-6">
                        <span class="text-[8px] font-black uppercase tracking-widest">{{ isRestock ? 'Restock' : 'Donation' }}</span>
                    </div>
                </div>
            {% else %}
                <div class="flex flex-col items-center justify-center py-32 bg-slate-50 rounded-[3rem] border-2 border-dashed border-slate-200">
                    <p class="text-slate-400 font-black uppercase text-[10px] tracking-widest">No matching movements recorded</p>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script src="{{ asset('js/transactions.js') }}"></script>
{% endblock %}
